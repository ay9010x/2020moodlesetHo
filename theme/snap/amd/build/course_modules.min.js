define(["jquery","core/ajax","theme_snap/util","theme_snap/responsive_video","theme_snap/ajax_notification"],function($,ajax,util,responsiveVideo,ajaxNotify){var updateModCompletion=function(a,b){a.find(".snap-asset-completion-tracking").html(b),$(document).trigger("snapModuleCompletionChange",a)},listenManualCompletion=function(){$(".course-content").on("submit","form.togglecompletion",function(a){a.preventDefault();var b=$(this);if(!b.hasClass("ajaxing")){var c=$(b).find('input[name="id"]').val(),d=$(b).find('input[name="completionstate"]').val(),e=$(b).parents("li.snap-asset").first();b.addClass("ajaxing"),ajax.call([{methodname:"theme_snap_course_module_completion",args:{id:c,completionstate:d},done:function(a){b.removeClass("ajaxing"),ajaxNotify.ifErrorShowBestMsg(a)||updateModCompletion(e,a.completionhtml)},fail:function(a){b.removeClass("ajaxing"),ajaxNotify.ifErrorShowBestMsg(a)}}],!0,!0)}})},revealPageMod=function(a,b){a.find(".pagemod-content").slideToggle("fast",function(){a.is(".state-expanded")?(a.attr("aria-expanded","true"),a.find(".pagemod-content").focus()):(a.attr("aria-expanded","false"),a.focus())}),b&&updateModCompletion(a,b),responsiveVideo.apply()},listenPageModuleReadMore=function(){var a=".modtype_page .instancename,.pagemod-readmore,.pagemod-content .snap-action-icon";$(document).on("click",a,function(a){var b=$(this).closest(".modtype_page");util.scrollToElement(b);var c=b.hasClass("state-expanded");b.toggleClass("state-expanded");var d=b.find(".pagemod-readmore"),e=b.find(".pagemod-content");if(1==e.data("content-loaded")){revealPageMod(b);var f=M.cfg.wwwroot+"/theme/snap/rest.php?action=read_page&contextid="+d.data("pagemodcontext");c||$.ajax({type:"GET",async:!0,url:f,success:function(a){ajaxNotify.ifErrorShowBestMsg(a)||updateModCompletion(b,a.completionhtml)}})}else if(c)revealPageMod(b);else{b.find(".contentafterlink").prepend('<div class="ajaxstatus alert alert-info">'+M.str.theme_snap.loading+"</div>");var g=M.cfg.wwwroot+"/theme/snap/rest.php?action=get_page&contextid="+d.data("pagemodcontext");$.ajax({type:"GET",async:!0,url:g,success:function(a){ajaxNotify.ifErrorShowBestMsg(a)||(e.prepend(a.html),e.data("content-loaded",1),b.find(".contentafterlink .ajaxstatus").remove(),revealPageMod(b,a.completionhtml))}})}a.preventDefault()})},lightboxMedia=function(resourcemod){var lightbox=function(a,b){var c=$("#snap-light-box");return 0===c.length&&($(a).append('<div id="snap-light-box" tabindex="-1"><div id="snap-light-box-content"></div><a id="snap-light-box-close" class="pull-right snap-action-icon" href="#"><i class="icon icon-close"></i><small>Close</small></a></div>'),$("#snap-light-box-close").click(function(a){a.preventDefault(),a.stopPropagation(),lightboxclose(),"function"==typeof b&&b()}),c=$("#snap-light-box")),c},lightboxclose=function(){var a=lightbox();a.remove()},lightboxopen=function(a,b,c){b=b?b:$("body");var d=lightbox(b,c);if(a){var e=$("#snap-light-box-content");e.html(""),e.append(a)}d.addClass("state-visible")},appendto=$("body"),spinner='<div class="loadingstat three-quarters">'+Y.Escape.html(M.util.get_string("loading","theme_snap"))+"</div>";lightboxopen(spinner,appendto,function(){$(resourcemod).attr("tabindex","-1").focus(),$(resourcemod).removeAttr("tabindex")}),$.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_media&contextid="+$(resourcemod).data("modcontext"),success:function(data){if(!ajaxNotify.ifErrorShowBestMsg(data)){lightboxopen(data.html,appendto),updateModCompletion($(resourcemod),data.completionhtml);var hasflowplayerscript=!1;if($("#snap-light-box script").each(function(){var script=$(this).text();script=script.replace(/^(?:\s*)\/\/<!\[CDATA\[/,"").replace(/\/\/\]\](?:\s*)$/,""),script.indexOf("M.util.add_video_player")>-1&&(hasflowplayerscript=!0,M.util.video_players=[]),eval(script)}),hasflowplayerscript){var jsurl;jsurl=-1==M.cfg.jsrev?M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.13.js":M.cfg.wwwroot+"/lib/javascript.php?jsfile=/lib/flowplayer/flowplayer-3.2.13.min.js&rev="+M.cfg.jsrev,$('head script[src="'+jsurl+'"]').remove(),"undefined"!=typeof flowplayer&&(flowplayer=void 0),M.util.load_flowplayer(),$('head script[src="'+jsurl+'"]').trigger("onreadystatechange")}window.setTimeout(function(){responsiveVideo.apply()},1e3),$("#snap-light-box").focus()}}})};return{init:function(){listenPageModuleReadMore(),listenManualCompletion(),$(document).on("click","[data-action=hide],[data-action=show]",function(){$(this).closest("li.activity").toggleClass("draft")}),$(document).on("click",".js-snap-media .snap-asset-link a",function(a){lightboxMedia($(this).closest(".snap-resource")),a.preventDefault()}),$(document).on("click",".snap-resource-card .snap-resource",function(a){var b=$(a.target),c="_self",d=$(b).closest(".snap-resource").find(".snap-asset-link a"),e="";d.length>0&&(e=$(d).attr("href"));var f=".snap-asset-completion-tracking, .snap-asset-actions, .contentafterlink a",g=$(b).closest(f).length;if(!g){if($(this).hasClass("js-snap-media"))lightboxMedia(this);else{if(""===e)return;"_blank"===$(d).attr("target")&&(c="_blank"),window.open(e,c)}a.preventDefault()}})}}});